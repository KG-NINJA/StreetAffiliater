name: Issue trigger - App Generation
on:
  issues:
    types:
      - opened
      - edited
      - reopened

jobs:
  generate-app:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v4

      - name: Node.js ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          npm install axios dotenv

      - name: èª²é¡Œã®è©³ç´°æƒ…å ±ã‚’å–å¾—
        id: issue_info
        run: |
          ISSUE_BODY="${{ github.event.issue.body }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          
          echo "title=${ISSUE_TITLE}" >> $GITHUB_OUTPUT
          echo "body=${ISSUE_BODY}" >> $GITHUB_OUTPUT
          echo "number=${ISSUE_NUMBER}" >> $GITHUB_OUTPUT

      - name: Codex Webã¸èª²é¡Œæƒ…å ±ã‚’é€ä¿¡
        id: webhook_response
        env:
          WEBHOOK_URL: ${{ secrets.CODEX_WEBHOOK_URL }}
        run: |
          if [ -z "${WEBHOOK_URL}" ]; then
            echo "CODEX_WEBHOOK_URL ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ãŸã‚é€ä¿¡ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            exit 0
          fi
          
          RESPONSE=$(curl --fail --show-error --silent \
            -X POST "${WEBHOOK_URL}" \
            -H "Content-Type: application/json" \
            -d @"${GITHUB_EVENT_PATH}")
          
          echo "response=${RESPONSE}" >> $GITHUB_OUTPUT
          echo "Codex Web å¿œç­”: ${RESPONSE}"

      - name: ã‚¢ãƒ—ãƒªç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
        if: contains(github.event.issue.labels.*.name, 'auto-pr')
        id: generate_app
        env:
          ISSUE_TITLE: ${{ steps.issue_info.outputs.title }}
          ISSUE_BODY: ${{ steps.issue_info.outputs.body }}
          ISSUE_NUMBER: ${{ steps.issue_info.outputs.number }}
        run: |
          mkdir -p generated-app
          
          node - "${{ env.ISSUE_TITLE }}" "${{ env.ISSUE_BODY }}" << 'EOF'
          const fs = require('fs');
          const path = require('path');
          
          const [appTitle, appDescription] = process.argv.slice(2);
          
          console.log(`ğŸ“¦ ã‚¢ãƒ—ãƒªç”Ÿæˆé–‹å§‹: ${appTitle}`);
          
          // React ã‚¢ãƒ—ãƒªã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç”Ÿæˆ
          const packageJson = {
            name: appTitle.toLowerCase().replace(/\s+/g, '-'),
            version: "1.0.0",
            description: appDescription || "Generated app",
            scripts: {
              start: "react-scripts start",
              build: "react-scripts build",
              test: "react-scripts test"
            },
            dependencies: {
              react: "^18.2.0",
              "react-dom": "^18.2.0",
              "react-scripts": "5.0.1"
            }
          };
          
          fs.writeFileSync('generated-app/package.json', JSON.stringify(packageJson, null, 2));
          
          // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
          const appComponent = `import React, { useState } from 'react';
          import './App.css';
          
          function App() {
            const [count, setCount] = useState(0);
          
            return (
              <div className="App">
                <header className="App-header">
                  <h1>${appTitle}</h1>
                  <p>${appDescription || 'Auto-generated application'}</p>
                  <div className="counter">
                    <p>Current count: {count}</p>
                    <button onClick={() => setCount(count + 1)}>Increment</button>
                    <button onClick={() => setCount(count - 1)}>Decrement</button>
                    <button onClick={() => setCount(0)}>Reset</button>
                  </div>
                </header>
              </div>
            );
          }
          
          export default App;`;
          
          fs.writeFileSync('generated-app/App.jsx', appComponent);
          
          // ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆ
          const appCss = `.App {
            text-align: center;
          }
          
          .App-header {
            background-color: #282c34;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: calc(10px + 2vmin);
            color: white;
          }
          
          h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
          }
          
          .counter {
            margin-top: 2rem;
            padding: 2rem;
            border: 2px solid #61dafb;
            border-radius: 8px;
          }
          
          button {
            margin: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            background-color: #61dafb;
            color: #282c34;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
          }
          
          button:hover {
            background-color: #4fa8c5;
          }`;
          
          fs.writeFileSync('generated-app/App.css', appCss);
          
          // index.js
          const indexJs = `import React from 'react';
          import ReactDOM from 'react-dom/client';
          import App from './App';
          import './index.css';
          
          const root = ReactDOM.createRoot(document.getElementById('root'));
          root.render(
            <React.StrictMode>
              <App />
            </React.StrictMode>
          );`;
          
          fs.writeFileSync('generated-app/index.js', indexJs);
          
          // index.html
          const indexHtml = `<!DOCTYPE html>
          <html lang="ja">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>${appTitle}</title>
          </head>
          <body>
            <div id="root"></div>
          </body>
          </html>`;
          
          fs.writeFileSync('generated-app/index.html', indexHtml);
          
          // README.md
          const readme = `# ${appTitle}
          
          ${appDescription || 'Auto-generated application'}
          
          ## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
          
          \`\`\`bash
          npm install
          npm start
          \`\`\`
          
          ## ãƒ“ãƒ«ãƒ‰
          
          \`\`\`bash
          npm run build
          \`\`\`
          `;
          
          fs.writeFileSync('generated-app/README.md', readme);
          
          console.log('âœ… ã‚¢ãƒ—ãƒªç”Ÿæˆå®Œäº†');
          console.log('ğŸ“ ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:');
          console.log('  - package.json');
          console.log('  - App.jsx');
          console.log('  - App.css');
          console.log('  - index.js');
          console.log('  - index.html');
          console.log('  - README.md');
          EOF
          
          echo "app_generated=true" >> $GITHUB_OUTPUT

      - name: ç”Ÿæˆã•ã‚ŒãŸã‚¢ãƒ—ãƒªã‚’ã‚³ãƒŸãƒƒãƒˆ
        if: steps.generate_app.outputs.app_generated == 'true'
        env:
          ISSUE_NUMBER: ${{ steps.issue_info.outputs.number }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add generated-app/
          git commit -m "ğŸ¤– Issue #${{ env.ISSUE_NUMBER }} ã‹ã‚‰ã‚¢ãƒ—ãƒªã‚’è‡ªå‹•ç”Ÿæˆ"
          git push

      - name: PRã‚’ä½œæˆ
        if: steps.generate_app.outputs.app_generated == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: 'ğŸ¤– Issue #${{ steps.issue_info.outputs.number }} ã‹ã‚‰ã‚¢ãƒ—ãƒªã‚’è‡ªå‹•ç”Ÿæˆ'
          title: 'âœ¨ Auto-generated app for Issue #${{ steps.issue_info.outputs.number }}'
          body: |
            ## ğŸ“¦ è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸã‚¢ãƒ—ãƒª
            
            Issue #${{ steps.issue_info.outputs.number }} ã«åŸºã¥ã„ã¦ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚
            
            ### ğŸ“ è©³ç´°
            - **ã‚¿ã‚¤ãƒˆãƒ«**: ${{ steps.issue_info.outputs.title }}
            - **èª¬æ˜**: ${{ steps.issue_info.outputs.body }}
            
            ### ğŸ“‚ ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
            - `generated-app/package.json` - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š
            - `generated-app/App.jsx` - ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
            - `generated-app/App.css` - ã‚¹ã‚¿ã‚¤ãƒ«
            - `generated-app/index.js` - ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
            - `generated-app/index.html` - HTML
            - `generated-app/README.md` - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
            
            ### ğŸš€ ä½¿ç”¨é–‹å§‹æ–¹æ³•
            ```bash
            cd generated-app
            npm install
            npm start
            ```
            
            ã“ã®PRã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ã€å¿…è¦ã«å¿œã˜ã¦å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚
          branch: auto-pr/issue-${{ steps.issue_info.outputs.number }}
          delete-branch: false
          labels: auto-generated, generated-app

      - name: ã‚¤ã‚·ãƒ¥ãƒ¼ã«ã‚³ãƒ¡ãƒ³ãƒˆ
        if: steps.generate_app.outputs.app_generated == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… ã‚¢ãƒ—ãƒªã®è‡ªå‹•ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\nç”Ÿæˆã•ã‚ŒãŸã‚¢ãƒ—ãƒªã¯ `generated-app/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚ã‚Šã¾ã™ã€‚\n\nã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨å®Ÿè¡Œ:\n```bash\ncd generated-app\nnpm install\nnpm start\n```'
            })

      - name: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° - ã‚¤ã‚·ãƒ¥ãƒ¼ã«ã‚³ãƒ¡ãƒ³ãƒˆ
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ ã‚¢ãƒ—ãƒªã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
            })
