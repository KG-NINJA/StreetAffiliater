name: Issue trigger

on:
  issues:
    types:
      - opened
      - edited
      - reopened

jobs:
  dispatch:
    runs-on: ubuntu-latest
    steps:
      - name: コードを取得
        uses: actions/checkout@v4

      - name: Codex Webへ課題情報を送信
        env:
          WEBHOOK_URL: ${{ secrets.CODEX_WEBHOOK_URL }}
        run: |
          # 日本語コメント: Webhook URLが未設定の場合は安全に終了する
          if [ -z "${WEBHOOK_URL}" ]; then
            echo "CODEX_WEBHOOK_URL が設定されていないため送信をスキップします。"
            exit 0
          fi
          curl --fail --show-error --silent \
            -X POST "${WEBHOOK_URL}" \
            -H "Content-Type: application/json" \
            --data @"${GITHUB_EVENT_PATH}" \
            --output /tmp/codex-web-response.json
          echo "Codex Web 応答:" && cat /tmp/codex-web-response.json

      - name: PR自動生成スクリプトを実行
        if: contains(github.event.issue.labels.*.name, 'auto-pr')
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          BASE_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          # 日本語コメント: 自動PR生成スクリプトを実行
          chmod +x ./codex_generate_and_pr.sh
          ./codex_generate_and_pr.sh "${ISSUE_NUMBER}"
